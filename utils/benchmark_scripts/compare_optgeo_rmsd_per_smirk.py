import os
import pickle
import numpy as np

import matplotlib
matplotlib.use('Agg')
from matplotlib.backends.backend_pdf import PdfPages
import matplotlib.pyplot as plt


def read_pickle_data(fnm):
    """
    Read data from pickled file generated by plot_optgeo_each_smirks.py

    The content of the pickle file:
    data_save = {
        'ffxml': args.ffxml,
        'tmp_folder': tmp_folder,
        'iter_folder': iter_folder,
        'data_qm_v_mm': data_qm_v_mm,
    }

    The main content is in data_qm_v_mm
    data_qm_v_mm[fftype][sid] = [
        {
            'mol2_fnm': mol2_fnm,
            'atom_indices': atom_indices,
            'smirks': smirks,
            'id': sid,
            'qm': qm,
            'mm': mm,
            'mm_iter0': None or mm of iter0,
        },
        ...
    ]
    """
    print(f'reading saved data from {fnm}')
    with open(fnm, 'rb') as pfile:
        data_save = pickle.load(pfile)
        data_qm_v_mm = data_save['data_qm_v_mm']
    return data_qm_v_mm

def compute_rmse(ref_data_list, target_data_list):
    a = np.array(ref_data_list)
    b = np.array(target_data_list)
    rmse = np.sqrt(np.sum((a-b)**2) / len(a))
    return rmse

def aggregate_compare_rmse_data(orig_data, new_data):
    agg_data = {}
    for fftype in orig_data:
        agg_data[fftype] = []
        for sid in sorted(orig_data[fftype], key=lambda s: int(s[1:] if s[-1].isdigit() else s[1:-1])):
            # aggregate orig and new rmse data into lists
            qm_list = [d['qm'] for d in orig_data[fftype][sid]]
            mm_orig_list = [d['mm'] for d in orig_data[fftype][sid]]
            mm_new_list = [d['mm'] for d in new_data[fftype][sid]]
            orig_rmse = compute_rmse(qm_list, mm_orig_list)
            new_rmse = compute_rmse(qm_list, mm_new_list)
            agg_data[fftype].append({
                'sid': sid,
                'orig_rmse': orig_rmse,
                'new_rmse': new_rmse,
            })
    return agg_data

def plot_compare_rmse_smirks(agg_data, fnm='compare_optgeo_rmse.pdf'):
    """ Generate bar plots for comparing benchmark results """
    xlabels = {
        'bonds': 'Bond Length RMSE (Angstrom)',
        'angles': 'Bond Angles RMSE (Degrees)',
        'propertorsions': 'Torsion Angles RMSE (Degrees)',
        'impropertorsions': 'Improper Torsion Angles RMSE (Degrees)'
    }
    with PdfPages(fnm) as pdf:
        for fftype, sid_data_list in agg_data.items():
            sid_list = [d['sid'] for d in sid_data_list]
            orig_rmse_array = np.array([d['orig_rmse'] for d in sid_data_list])
            new_rmse_array = np.array([d['new_rmse'] for d in sid_data_list])
            rmse_changes = new_rmse_array - orig_rmse_array
            # make plot
            n = len(sid_list)
            y_pos = np.arange(n)
            plt.figure(figsize=(8.5, n*0.12+1.2))
            # plot the initial rmse
            # plt.barh(y_pos, orig_rmse_array, tick_label=sid_list, height=0.8, color='C0', align='center')
            plt.scatter(orig_rmse_array, y_pos, marker='o', s=80, facecolors='none', edgecolors='grey')
            plt.yticks(y_pos, sid_list)
            # plot the changes in different colors
            increase_idxs = np.nonzero(rmse_changes >=0)[0]
            decrease_idxs = np.nonzero(rmse_changes <0)[0]
            xmin = 0
            xmax = max(orig_rmse_array.max(), new_rmse_array.max())
            head_length = 0.01*(xmax-xmin)
            for i in increase_idxs:
                if abs(rmse_changes[i]) > head_length:
                    plt.arrow(orig_rmse_array[i], y_pos[i], rmse_changes[i], 0.0, head_width=0.4, head_length=head_length, length_includes_head=True, width=0.05, color='C3')
            for i in decrease_idxs:
                if abs(rmse_changes[i]) > head_length:
                    plt.arrow(orig_rmse_array[i], y_pos[i], rmse_changes[i], 0.0, head_width=0.4, head_length=head_length, length_includes_head=True, width=0.05, color='C2')
            # Compute some metrics for a table
            print("Parameter type: %s" % fftype)
            print("Total number of parameters: %i" % len(sid_data_list))
            print("Parameters improved: %i/%i (%.1f%%)" % (len(decrease_idxs), len(sid_data_list), 100.0*len(decrease_idxs)/len(sid_data_list)))
            print("Average RMSE change: %.4f -> %.4f (%.4f, %.1f%%)" % (np.mean(orig_rmse_array), np.mean(orig_rmse_array+rmse_changes), np.mean(rmse_changes), 100.0*np.mean(rmse_changes)/np.mean(orig_rmse_array)))
            # plt.barh(y_pos[increase_idxs], rmse_changes[increase_idxs], left=orig_rmse_array[increase_idxs], height=0.6, color='C3', align='center')
            # plt.barh(y_pos[decrease_idxs], rmse_changes[decrease_idxs], left=orig_rmse_array[decrease_idxs], height=0.6, color='C2', align='center')
            # adjust the y range, and invert the yaxis
            #plt.ylim(y_pos[0]-1, y_pos[-1]+1)
            plt.ylim(y_pos[-1]+1, y_pos[0]-1)
            # adjust the x range
            padding = (xmax - xmin) * 0.01
            plt.xlim(xmin, xmax+padding)
            plt.xlabel(xlabels[fftype.lower()])
            # save
            plt.title(f'RMSE comparison for {fftype}')
            plt.tight_layout()
            pdf.savefig()  # saves the current figure into a pdf page
            plt.close()
    print(f"RMSE compare plots saved as {fnm}")

def main():
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument('orig_data_pickle', help='pickled data from orig evaluation')
    parser.add_argument('new_data_pickle', help='pickled data from new evaluation')
    args = parser.parse_args()

    orig_data = read_pickle_data(args.orig_data_pickle)
    new_data = read_pickle_data(args.new_data_pickle)

    agg_data = aggregate_compare_rmse_data(orig_data, new_data)

    plot_compare_rmse_smirks(agg_data)

if __name__ == "__main__":
    main()
